# <img src="https://twiki.cern.ch/twiki/pub/BEABP/Logos/OMC_logo.png" height="28"> 3

[![Cron Testing](https://github.com/pylhc/omc3/workflows/Cron%20Testing/badge.svg)](https://github.com/pylhc/omc3/actions?query=workflow%3A%22Cron+Testing%22)
[![Code Climate coverage](https://img.shields.io/codeclimate/coverage/pylhc/omc3.svg?style=popout)](https://codeclimate.com/github/pylhc/omc3)
[![Code Climate maintainability (percentage)](https://img.shields.io/codeclimate/maintainability-percentage/pylhc/omc3.svg?style=popout)](https://codeclimate.com/github/pylhc/omc3)
[![GitHub last commit](https://img.shields.io/github/last-commit/pylhc/omc3.svg?style=popout)](https://github.com/pylhc/omc3/)
[![GitHub release](https://img.shields.io/github/release/pylhc/omc3.svg?style=popout)](https://github.com/pylhc/omc3/)

This is the python-tool package of the optics measurements and corrections team (OMC) at CERN.

If you are not part of that group, you will most likely have no use for the codes provided here, unless you have a 9km wide accelerator at home.
Feel free to use them anyway, if you wish!

## Documentation

- Autogenerated docs via `Sphinx` can be found on <https://pylhc.github.io/omc3/>.
- General documentation of the OMC-Teams software on <https://twiki.cern.ch/twiki/bin/view/BEABP/OMC>

## Getting Started

### Prerequisites

The codes use a multitude of packages as can be found in the [`setup.py`](setup.py) file.

Important ones are: `numpy`, `pandas` and `scipy` as well as our `tfs-pandas`, `sdds` and `generic_parser`.

### Installing

To use the codes, a local copy should be obtained via `git clone`,  which then has to be either installed using
`pip install -e /path/to/omc3` or can be used temporarily by appending the path to `PYTHONPATH`.

Alternatively, the previous two steps can be combined with `pip install git+https://github.com/pylhc/omc3.git`.

After installing, codes can be run with either `python -m omc3.SCRIPT --FLAG ARGUMENT` or calling path to the `.py` file directly.

## Functionality

#### Main Scripts

Main scripts to be executed lie in [`/omc3`](omc3) directory. These include
- `hole_in_one.py` to perform frequency analysis on turn by turn BPM data and infer optics and more for a given accelerator
- `madx_wrapper.py` to start a MADX with a file or string as input
- `model_creator.py` to provide optics models required for optics analysis
- `run_kmod.py` to analyse data from K-modulation and return measured optics functions
- `tbt_converter.py` to convert different turn by turn datatypes to sdds and add noise
- `amplitude_detuning_analysis.py` to perform amp. det. analysis on optics data with tune correction

#### Plotting Scripts

Plotting scripts for analysis outputs can be found in [`/omc3/plotting`](omc3/plotting)
- `plot_spectrum.py` to generate plots from files generated by frequency analysis
- `plot_bbq.py` to generate plots from files generated by bbq analysis
- `plot_amplitude_detuning.py` to generate plots from files generated by amplitude detuning analysis
- `plot_optics_measurements.py` to generate plots from files generated by optics_measurements
- `plot_tfs.py` all purpose tfs-file plotter

#### Other Scripts

Other general utility scripts are in [`/omc3/scripts`](omc3/scripts)
- `update_nattune_in_linfile.py` to update the natural tune columns in the lin files by finding the highest
peak in the spectrum in a given interval
- `write_madx_macros.py` to generate madx tracking macros with observation points from a twissfile

#### Examples

Examples can be found in the [`tests`](tests) files.

### Changelog

See the [CHANGELOG](CHANGELOG.md) file.

### Development in progress

- Regression tests
- Responsematrix calculation
- Global corrections

## Quality checks

Issues and introduction of new features should take place in branches. After completion, a pull request should be created and merging into the master branch
is possible after positive review of a reviewer. More details can be found [here](https://twiki.cern.ch/twiki/bin/view/BEABP/Git).
Coding style guide is found [here](https://twiki.cern.ch/twiki/bin/view/BEABP/PythonStyleGuide).

### Tests

- Pytest unit- and accuracy-tests are run automatically after each commit via [Github Actions](https://github.com/pylhc/omc3/actions).
- Another [README](.github/workflows/README.md) details the different CI workflows implemented.

### Maintainability

- Additional checks for code-complexity, design-rules, test-coverage, duplication on [CodeClimate](https://codeclimate.com/github/pylhc/omc3).

## Related Packages

- [tfs-pandas](https://github.com/pylhc/tfs)
- [sdds-reader](https://github.com/pylhc/sdds)
- [generic parser](https://github.com/pylhc/generic_parser)
- [PyLHC](https://github.com/pylhc/PyLHC)
- [Beta-Beat Source](https://github.com/pylhc/Beta-Beat.src)
- [optics functions](https://github.com/pylhc/optics_functions)

## Hints for Developers

### Install in Editable Mode

In case you want to install `omc3` as a development package
from the current folder, you can use:

```
git clone https://github.com/pylhc/omc3
pip install --editable omc3
```

This installs the package as a link into the python environment and any changes 
are reflected immediately, without the need to reinstall.

#### Dependencies

You can install dependencies suited to your use case with the following commands:
```
pip install --editable omc3[test]
pip install --editable omc3[test,doc]
pip install --editable omc3[all]
```
where the last one installs **all** dependencies defined in `setup.py`.

Note that the default dependencies and omc3-as-link are also always installed.

## Authors

* **pyLHC/OMC-Team** - *Working Group* - [pyLHC](https://github.com/orgs/pylhc/teams/omc-team)

## License
This project is licensed under the `GNU GPLv3` License.
Please take a moment to check its permissivity - see the [LICENSE](LICENSE) file for details.