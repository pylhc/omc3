SET, FORMAT="22.14e";

circum=260.;
lcell=20.;

f=lcell/sin(pi/4)/4;

kf=1.0/f;
kd=-1.0/f;

kfx:=kf;
kdx:=kd;

kf1=1.0/f;
kd1=-1.0/f;
kf2=1.0/f;
kd2=-1.0/f;
kf3=1.0/f;
kd3=-1.0/f;

sk=0.0;

dkf=0;
dkd=0;
kofx=0;
kodx=0;

dphix = +0.03;
dphiy = +0.06;

BEAM;

bpm: MONITOR, L=0;

qf: multipole, knl:={0, kf};
qd: multipole, knl:={0, kd};

qfk: multipole, knl:={0, kf+dkf};
qdk: multipole, knl:={0, kd-dkd};

qfx: multipole, knl:={0,kfx,0, 0};
qdx: multipole, knl:={0,kdx,0, 0};

qfp1: multipole, knl:={0, kf1};
qdp1: multipole, knl:={0, kd1};
qfp2: multipole, knl:={0, kf2};
qdp2: multipole, knl:={0, kd2};
qfp3: multipole, knl:={0, kf3};
qdp3: multipole, knl:={0, kd3};

sq1:  multipole, ksl:={0, ska};
sq2: multipole, ksl:={0, skc};

sq3:  multipole, ksl:={0, skb};
sq4: multipole, ksl:={0, skd};


cell: sequence, refer=center, l=lcell;
    smark: marker, at=0.;
    qf:qf, at=0.25*lcell;
    qd:qd, at=0.75*lcell;
    
endsequence;

phaseshiftcell: sequence, refer=center, l=3*lcell;

    qfp1:qfp1, at=0.25*lcell;
    qdp1:qdp1, at=0.75*lcell;
    qfp2:qfp2, at=1.25*lcell;
    qdp2:qdp2, at=1.75*lcell;
    qfp3:qfp3, at=2.25*lcell;
    qdp3:qdp3, at=2.75*lcell;

endsequence;

seq: sequence, refer=center, l=circum;
startark: marker, at=0;
qf1:qf, at=0.25*lcell;
bpm1: bpm, at=0.37*lcell;
qdx:qdx, at=0.75*lcell;
qfx:qfx, at=1.25*lcell;
qd1:qd, at=1.75*lcell;
qf2:qf, at=2.25*lcell;
bpm2: bpm, at=2.37*lcell;
qd2:qd, at=2.75*lcell;
phaseshiftcell, at=4.5*lcell;
qf3:qfk, at=6.25*lcell;
bpm3: bpm, at=6.37*lcell;
qd3:qdk, at=6.75*lcell;
qf4:qfk, at=7.25*lcell;
bpm4: bpm, at=7.37*lcell;
qd4:qdk, at=7.75*lcell;
qf5:qfk, at=8.25*lcell;
bpm5: bpm, at=8.37*lcell;
qd5:qdk, at=8.75*lcell;
qf6:qfk, at=9.25*lcell;
bpm6: bpm, at=9.37*lcell;
qd6:qdk, at=9.75*lcell;
qf7:qf, at=10.25*lcell;
qd7:qd, at=10.75*lcell;
qf8:qf, at=11.25*lcell;
qd8:qd, at=11.75*lcell;
qf9:qf, at=12.25*lcell;
qd9:qd, at=12.75*lcell;
endsequence;

USE, SEQUENCE = cell;

MATCH, SEQUENCE = cell;
    
    VARY, NAME = kf, LOWER = -1E22, UPPER = 1E22;
    VARY, NAME = kd, LOWER = -1E22, UPPER = 1E22;

    CONSTRAINT, RANGE = #E, MUX=0.25;
    CONSTRAINT, RANGE = #E, MUY=0.25;
    
    LMDIF, CALLS = 5000, TOLERANCE = 1E-14;
    
ENDMATCH;

TWISS;
betxstart=table(twiss,smark,betx);
betystart=table(twiss,smark,bety);
alfxstart=table(twiss,smark,alfx);
alfystart=table(twiss,smark,alfy);

VALUE, betxstart;
VALUE, betystart;
VALUE, alfxstart;
VALUE, alfystart;


USE, SEQUENCE = phaseshiftcell;

MATCH, SEQUENCE = phaseshiftcell, BETX = betxstart, ALFX=alfxstart, BETY=betystart, ALFY=alfystart;
    
    VARY, NAME = kf1, LOWER = -1E22, UPPER = 1E22;
    VARY, NAME = kd1, LOWER = -1E22, UPPER = 1E22;
    VARY, NAME = kf2, LOWER = -1E22, UPPER = 1E22;
    VARY, NAME = kd2, LOWER = -1E22, UPPER = 1E22;
    VARY, NAME = kf3, LOWER = -1E22, UPPER = 1E22;
    VARY, NAME = kd3, LOWER = -1E22, UPPER = 1E22;

    CONSTRAINT, RANGE = #E, BETX=betxstart;
    CONSTRAINT, RANGE = #E, ALFX=alfxstart;
    CONSTRAINT, RANGE = #E, BETY=betystart;
    CONSTRAINT, RANGE = #E, ALFY=alfystart;
    CONSTRAINT, RANGE = #E, MUX=0.75+dphix;
    CONSTRAINT, RANGE = #E, MUY=0.75+dphiy;
    
    LMDIF, CALLS = 7000, TOLERANCE = 1E-21;
    JACOBIAN, CALLS = 2000, TOLERANCE= 1E-22;
ENDMATCH;


BEAM;
USE, SEQUENCE = seq;
SELECT, FLAG = TWISS, CLEAR;
TWISS, RIPKEN=TRUE, centre;

betxstart=TABLE(twiss,startark,betx);
betystart=TABLE(twiss,startark,bety);
alfxstart=TABLE(twiss,startark,alfx);
alfystart=TABLE(twiss,startark,alfy);

VALUE, betxstart;
VALUE, betystart;
VALUE, alfxstart;
VALUE, alfystart;

EOPTION, SEED=1;

PTC_CREATE_UNIVERSE;
PTC_CREATE_LAYOUT, MODEL=3, METHOD=4, NST=3;

SELECT, FLAG=ptc_twiss, COLUMN=name,s,beta11,beta12,alfa11,mu1,beta22,alfa22,mu2,disp1,disp2,disp3,disp4;
// ptc_twiss,closed_orbit=true,no=6,icase=5,file="dr_ptc_twiss_nnn.tfs";
n = 1;
while (n<=2) {
	Nsigmax=0.01;
	Nsigmay=0.01;
	Nsigmapx=0.01;
	Nsigmapy=0.01;
	value,Nsigmax;
	value,Nsigmay;
	
	enomphysy=1e-3;
	enomphysx=1e-3;


	myx=sqrt(BETXSTART)*Nsigmax*sqrt(enomphysx);
	myy=sqrt(BETYSTART)*Nsigmay*sqrt(enomphysy);

	mypx= -1*Nsigmax*sqrt(enomphysx)*(ALFXSTART)/SQRT(BETXSTART)+ Nsigmapx*sqrt(enomphysx)/sqrt(BETXSTART);
	mypy= -1*Nsigmay*sqrt(enomphysy)*(ALFYSTART)/SQRT(BETYSTART)+ Nsigmapy*sqrt(enomphysy)/sqrt(BETYSTART);

	n=n+1;	

PTC_START, x=myx, px=mypx, y=myy, py=mypy;
};
PTC_OBSERVE, place=bpm1;
PTC_OBSERVE, place=bpm2;
PTC_OBSERVE, place=bpm3;


PTC_TRACK, ICASE=5, CLOSED_ORBIT, FILE=test_trackone., TURNS=256, NORM_NO=5, ELEMENT_BY_ELEMENT, RECLOSS, ONETABLE=TRUE, MAXAPER={10,10,10,10,10,10};
PTC_TRACK_END;
PTC_END;
